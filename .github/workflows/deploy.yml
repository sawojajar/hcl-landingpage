name: Deploy to Hostinger VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Run linter
      run: yarn lint

    - name: Build application
      run: yarn build
      env:
        ENABLE_INDEXING_SEO: ${{ secrets.ENABLE_INDEXING_SEO }}
        ADMIN_WHATSAPP_NUMBER: ${{ secrets.ADMIN_WHATSAPP_NUMBER }}
        ADMIN_WHATSAPP_CHAT_FORMAT: ${{ secrets.ADMIN_WHATSAPP_CHAT_FORMAT }}
        FIRST_CATEGORY: ${{ secrets.FIRST_CATEGORY }}
        BASE_URL: ${{ secrets.BASE_URL }}

    - name: Create deployment package
      run: |
        tar -czf deployment.tar.gz \
          .next \
          public \
          package.json \
          yarn.lock \
          next.config.js \
          tsconfig.json

    - name: Deploy to VPS
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          # Create deployment directory if it doesn't exist
          mkdir -p /var/www/hcl-landingpage
          cd /var/www/hcl-landingpage
          
          # Backup current deployment
          if [ -d ".next" ]; then
            sudo rm -rf .next.backup
            sudo mv .next .next.backup
          fi
          
          # Stop the application if running
          sudo systemctl stop hcl-landingpage || true

    - name: Upload and extract deployment
      if: github.ref == 'refs/heads/main'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "deployment.tar.gz"
        target: "/var/www/hcl-landingpage/"

    - name: Finalize deployment
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          cd /var/www/hcl-landingpage
          
          # Extract deployment
          tar -xzf deployment.tar.gz
          rm deployment.tar.gz
          
          # Install production dependencies
          yarn install --production --frozen-lockfile
          
          # Set proper permissions
          sudo chown -R www-data:www-data /var/www/hcl-landingpage
          sudo chmod -R 755 /var/www/hcl-landingpage
          
          # Create environment file
          sudo tee /var/www/hcl-landingpage/.env.local > /dev/null <<EOF
          ENABLE_INDEXING_SEO=${{ secrets.ENABLE_INDEXING_SEO }}
          ADMIN_WHATSAPP_NUMBER=${{ secrets.ADMIN_WHATSAPP_NUMBER }}
          ADMIN_WHATSAPP_CHAT_FORMAT=${{ secrets.ADMIN_WHATSAPP_CHAT_FORMAT }}
          FIRST_CATEGORY=${{ secrets.FIRST_CATEGORY }}
          BASE_URL=${{ secrets.BASE_URL }}
          NODE_ENV=production
          PORT=3000
          EOF
          
          # Restart the application
          sudo systemctl restart hcl-landingpage
          sudo systemctl status hcl-landingpage

    - name: Cleanup
      if: always()
      run: rm -f deployment.tar.gz
