name: Deploy to Hostinger VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual deployment

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Run linter
      run: yarn lint

    - name: Build application
      run: yarn build
      env:
        ENABLE_INDEXING_SEO: ${{ secrets.ENABLE_INDEXING_SEO }}
        ADMIN_WHATSAPP_NUMBER: ${{ secrets.ADMIN_WHATSAPP_NUMBER }}
        ADMIN_WHATSAPP_CHAT_FORMAT: ${{ secrets.ADMIN_WHATSAPP_CHAT_FORMAT }}
        FIRST_CATEGORY: ${{ secrets.FIRST_CATEGORY }}
        BASE_URL: ${{ secrets.BASE_URL }}

    - name: Test build output
      run: |
        echo "ğŸ“‹ Build output verification:"
        ls -la .next/
        echo "âœ… Build completed successfully"

    - name: Create deployment package
      run: |
        echo "ğŸ“¦ Creating deployment package..."
        tar -czf deployment.tar.gz \
          .next \
          public \
          package.json \
          yarn.lock \
          next.config.js \
          tsconfig.json
        echo "âœ… Deployment package created: $(du -h deployment.tar.gz | cut -f1)"

    - name: Test SSH Connection
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "ğŸ” Testing SSH connection..."
          echo "âœ… SSH connection successful!"
          echo "Host: $(hostname)"
          echo "User: $(whoami)"
          echo "Date: $(date)"
          echo "Working directory: $(pwd)"

    - name: Pre-deployment Setup
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "ğŸš€ Starting pre-deployment setup..."
          
          # Create deployment directory if it doesn't exist
          mkdir -p /var/www/hcl-landingpage
          cd /var/www/hcl-landingpage
          
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‹ Directory contents:"
          ls -la
          
          # Backup current deployment
          if [ -d ".next" ]; then
            echo "ğŸ’¾ Backing up current deployment..."
            sudo rm -rf .next.backup
            sudo mv .next .next.backup
            echo "âœ… Backup completed"
          else
            echo "â„¹ï¸ No existing deployment to backup"
          fi
          
          # Stop the application if running
          echo "â¹ï¸ Stopping application service..."
          sudo systemctl stop hcl-landingpage || echo "â„¹ï¸ Service not running or doesn't exist yet"
          echo "âœ… Service stopped"

    - name: Upload deployment package
      if: github.ref == 'refs/heads/main'
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "deployment.tar.gz"
        target: "/var/www/hcl-landingpage/"
        strip_components: 0

    - name: Deploy Application
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          set -e  # Exit on any error
          
          echo "ğŸš€ Starting deployment process..."
          cd /var/www/hcl-landingpage
          
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‹ Directory contents before extraction:"
          ls -la
          
          echo "ğŸ“¦ Extracting deployment package..."
          if [ -f "deployment.tar.gz" ]; then
            echo "âœ… Found deployment.tar.gz, extracting..."
            tar -xzf deployment.tar.gz
            rm deployment.tar.gz
            echo "âœ… Deployment package extracted and cleaned up"
          else
            echo "âŒ deployment.tar.gz not found!"
            echo "ğŸ“‹ Available files:"
            ls -la
            exit 1
          fi
          
          echo "ğŸ“‹ Extracted files:"
          ls -la
          
          echo "ğŸ“¦ Installing production dependencies..."
          if command -v yarn >/dev/null 2>&1; then
            yarn install --production --frozen-lockfile
            echo "âœ… Dependencies installed with yarn"
          elif command -v npm >/dev/null 2>&1; then
            npm ci --only=production
            echo "âœ… Dependencies installed with npm"
          else
            echo "âŒ Neither yarn nor npm found!"
            exit 1
          fi
          
          echo "ğŸ”§ Setting proper permissions..."
          sudo chown -R www-data:www-data /var/www/hcl-landingpage
          sudo chmod -R 755 /var/www/hcl-landingpage
          echo "âœ… Permissions set"
          
          echo "âš™ï¸ Creating environment file..."
          sudo tee /var/www/hcl-landingpage/.env.local > /dev/null <<EOF
          ENABLE_INDEXING_SEO=${{ secrets.ENABLE_INDEXING_SEO }}
          ADMIN_WHATSAPP_NUMBER=${{ secrets.ADMIN_WHATSAPP_NUMBER }}
          ADMIN_WHATSAPP_CHAT_FORMAT=${{ secrets.ADMIN_WHATSAPP_CHAT_FORMAT }}
          FIRST_CATEGORY=${{ secrets.FIRST_CATEGORY }}
          BASE_URL=${{ secrets.BASE_URL }}
          NODE_ENV=production
          PORT=3000
          EOF
          echo "âœ… Environment file created"
          
          echo "ğŸ”„ Starting application service..."
          if sudo systemctl is-enabled hcl-landingpage >/dev/null 2>&1; then
            echo "âœ… Service is enabled, restarting..."
            sudo systemctl restart hcl-landingpage
            sleep 5
            echo "ğŸ“Š Checking service status..."
            sudo systemctl status hcl-landingpage --no-pager
          else
            echo "âš ï¸ Service not enabled, starting manually..."
            cd /var/www/hcl-landingpage
            nohup yarn start > app.log 2>&1 &
            echo "âœ… Application started manually"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"

    - name: Health Check
      if: github.ref == 'refs/heads/main'
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          echo "ğŸ¥ Running health checks..."
          
          # Check if application is running
          if curl -f http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… Application is responding on port 3000"
          else
            echo "âŒ Application is not responding on port 3000"
            echo "ğŸ“‹ Checking service status:"
            sudo systemctl status hcl-landingpage --no-pager
            exit 1
          fi
          
          # Check if Nginx is running
          if curl -f http://localhost:80 >/dev/null 2>&1; then
            echo "âœ… Nginx is responding on port 80"
          else
            echo "âŒ Nginx is not responding on port 80"
            echo "ğŸ“‹ Checking Nginx status:"
            sudo systemctl status nginx --no-pager
            exit 1
          fi
          
          # Check if domain is accessible
          if curl -f http://${{ secrets.BASE_URL || 'pompahcl.com' }} >/dev/null 2>&1; then
            echo "âœ… Domain is accessible"
          else
            echo "âš ï¸ Domain might not be accessible yet (DNS propagation)"
          fi
          
          echo "ğŸ‰ All health checks passed!"

    - name: Deployment Summary
      if: github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ‰ Deployment Summary"
        echo "==================="
        echo "âœ… Build completed successfully"
        echo "âœ… Application deployed to VPS"
        echo "âœ… Health checks passed"
        echo ""
        echo "ğŸŒ Your website is now live at:"
        echo "   http://${{ secrets.BASE_URL || 'pompahcl.com' }}"
        echo "   http://${{ secrets.VPS_HOST }}"
        echo ""
        echo "ğŸ“Š Deployment completed at: $(date)"

    - name: Cleanup
      if: always()
      run: rm -f deployment.tar.gz
